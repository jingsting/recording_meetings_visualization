<!doctype html>
<html>
<body>
    <h1>testing</h1>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider@0.2.1/build/d3-simple-slider.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.0.4/math.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
<script>
function loadJSON(){
    var ourRequest = new XMLHttpRequest();
    d3.selectAll("div").remove();
    d3.selectAll("svg").remove();
    d3.selectAll("text").remove();
    d3.selectAll("circle").remove();
    d3.selectAll("rect").remove();
    ourRequest.open("GET", "/js9")
    ourRequest.onload = function(){
        var total_json = JSON.parse(ourRequest.responseText);
////===================================================================================

        /////////code here////////////
        var list_dict=parsing_info(total_json);
        var dictionary_of_how_much_and_many=list_dict[1];
        var numParticipants=list_dict[0];
        var all_angles=[];
        var circleData = [];
        var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "hidden")
            .style("color", "white")
            .style("padding", "8px")
            .style("background-color", "rgba(0, 0, 0, 0.50)")
            .style("border-radius", "6px")
            .style("font", "12px sans-serif")
            .text("tooltip");
        var alpha = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
        //--------------------------------------------------creation of svg--------------------------------
        var svgContainer = d3.select("body")
            .append("svg")
            .attr("width", 750)
            .attr("height", 750)
            .style("border", "1px solid black");
        //-------------------------------------------------------------------------------------------------
        var colors = d3.scaleLinear().domain([1,50])
            .interpolate(d3.interpolateHcl)
            .range([d3.rgb("#FFFFFF"), d3.color("#ff0000")]);
        //-----------------------------------------------creates the circles-------------------------------
        for(i = 0; i < numParticipants; i++) {// formula from here http://bl.ocks.org/bycoffe/3404776
            var x = 0;
            var x_1 = [];
            var y = 0;
            var y_1 = [];
            var angle = (i / numParticipants) * 2 * Math.PI;
            all_angles.push(angle)
            x = (80 * Math.cos(angle)) + (770/2);
            y = (80 * Math.sin(angle)) + (770/2);
            x_1.push( ((150+8) * Math.cos(angle)) + (770/2) );
            y_1.push( ((150+8) * Math.sin(angle)) + (770/2) );
            var circle = svgContainer.append("circle")
                .attr("cx", x)
                .attr("cy", y)
                .attr("r", 25)
                .attr("id", i)
                .style("stroke", "black")
                .style("fill",colors(0))
                .style("padding", 2)
                .on("mouseover", function() {
                    return tooltip.text("Times Spoken: " + 0 + " Total Time: "  + 0).style("visibility", "visible");
                })
                .on("mousemove", function() {
                    return tooltip.style("top", (d3.event.pageY-10)+"px")
                                .style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function() {
                    return tooltip.style("visibility", "hidden");
                });
            
            circleData.push(circle);
            var id = parseInt(circleData[i].attr("id"));
            var text = svgContainer.append("text")
                .attr("x", x)
                .attr("y", y + 6)
                .text(alpha[id])
                .attr("id",i.toString())
                .attr("font-family", "san-serif")
                .attr("font-size", "20px")
                .attr("fill", "black")
                .attr("text-anchor", "middle")
                .on("mouseover", function() {
                    return tooltip.text("Times Spoken: " + 0 + " Total Time: "  + 0).style("visibility", "visible");
                })
                .on("mousemove", function() {
                    return tooltip.style("top", (d3.event.pageY-10)+"px")
                                .style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function() {
                    return tooltip.style("visibility", "hidden");
                });
        }
        //----------------------------------------------------------create dictionary of angles------------------------------------------------------------------
        var dict_angles=[];
        for(var i=0;i<all_angles.length;i++){
            dict_angles.push({
                key: i,
                value: all_angles[i]
            });
        }
        //------------------------------------------------------------creates rectangles and words---------------------------------------------------------------
        var imp_info = format_text(svgContainer, list_dict[2],dict_angles,list_dict[3],80);
        last_speaker(list_dict[2],list_dict[3],circleData);
////===================================================================================
    }
    ourRequest.send();
    }
    function startVis(){
        var inter = setInterval(function() {
        loadJSON();
        }, 2500);
    }
    startVis();
//------------------------------------------------------------can refine tex-wrap function more later----------------------------------------------------
function format_text(object,sentences,dictionary_of_angles,person,radius){
    var words = sentences.split(" ");
    if(Math.round(Math.sqrt(words.length)/2)>2){
        dimensions= Math.round(Math.sqrt(words.length)/2)}
    else{dimensions = 2}
    var containers=[];
    for(var i=0;i<words.length;i){
        var temp = "";
        var counter=0;
        while (counter<dimensions && i<words.length){
            if (temp.length!=0){
                temp+=" ";
            }
            temp+=words[i];
            i++;counter++;
        }
        containers.push(temp);
    }
    var longest_= 0
    var index = 0
    for(var k=0; k<containers.length; k++){
        if(containers[k].length>longest_){
            longest_=containers[k].length;
            index=k;
        }
    }
    object.append("text").attr("x",300).attr("y",300).attr("id","test_text").text(containers[index]);
    var pixel_length = d3.select("#test_text").node().getComputedTextLength();
    d3.select("#test_text").remove();
    var long_length=Math.sqrt(((30+15*(containers.length-1))**2)+((pixel_length+20))**2);
    var x=((radius+50+long_length/2) * Math.cos(dictionary_of_angles[person].value));
    var y=((radius+50+long_length/2) * Math.sin(dictionary_of_angles[person].value));
    for(var i=0; i<containers.length;i++){
        object.append("text").attr("x",(x+770/2)-(pixel_length)/2).attr("y",(y+770/2-(15*(containers.length-1))/2+i*15)).attr("id","text_box").text(containers[i]);
    }
    object.append("rect")
        .attr("x", ((radius+50+long_length/2) * Math.cos(dictionary_of_angles[person].value)) + (770/2)- ((pixel_length+10)/2))
        .attr("y", ((radius+50+long_length/2) * Math.sin(dictionary_of_angles[person].value)) + (770/2) -(30+15*(containers.length-1))/2)
        .attr("rx",10)
        .attr("ry",10)
        .attr("id","rect_box")
        .attr("width", pixel_length+20)
        .attr("height", 25+15*(containers.length-1))
        .attr("stroke","black")
        .attr("fill","none")
        .attr("id","rect_box")
        .attr("border", "1px solid black");
}
//---------------------------------------------------------------------takes and puts all the info in the correct variables---------------------------------------------------
function parsing_info(data){
    var size_of_dict=0
    var last_words='';
    var dictionary_of_much_and_many=[];
    var all_the_users=[];
    var last_person;
    for(var i=0;i<data.length;i++){
        if(!found(all_the_users,data[i].speaker)){
            all_the_users.push(data[i].speaker)};
        last_words=data[i].text
        last_person=data[i].speaker
    }
    all_the_users=all_the_users.sort(function(a, b){return a-b});// if users are integers
    for(var j=0;j<all_the_users.length;j++){
        dictionary_of_much_and_many.push({
            key: all_the_users[j],
            value: [0,0] //much, many
        });
        size_of_dict=j+1;
    }
    for(var i=0;i<data.length;i++){
        dictionary_of_much_and_many[data[i].speaker].value[0]+=(data[i].end - data[i].start);
        dictionary_of_much_and_many[data[i].speaker].value[1]++;
    }
    return [size_of_dict, dictionary_of_much_and_many, last_words,last_person];
}
//-----------------------------------------------------------------------------previous speaker--------------------------------------------------------------------------------
function last_speaker(/*takes in last object in json*/last_line, user_person, circledatas){
    circledatas[user_person].style("stroke", "lightpink").style("stroke-width", "5px");
}
//-----------------------------------------------------------------------function to see if element is in array----------------------------------------------------------------
function found(arr,ele){
    return arr.find(function(element){return element == ele;})==ele;
}
//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</script>
</body>
</html>